# üìä –ê–Ω–∞–ª–∏–∑: –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è

## üéØ –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### ‚úÖ –≠—Ç–∞–ø 2: Redis —Å—á—ë—Ç—á–∏–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
- **–ú–µ—Ç–æ–¥—ã –≤ `database.py`**:
  - `increment_user_downloads(user_id)` - –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á—ë—Ç—á–∏–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
  - `get_user_downloads_count(user_id)` - –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
  - `increment_video_downloads(video_id)` - –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á—ë—Ç—á–∏–∫–∞ –¥–ª—è –≤–∏–¥–µ–æ
  - `get_user_downloads_today(user_id)` - —Å—á—ë—Ç—á–∏–∫ –∑–∞ –¥–µ–Ω—å (—Å TTL 3 –¥–Ω—è)
  - `get_user_downloads_month(user_id)` - —Å—á—ë—Ç—á–∏–∫ –∑–∞ –º–µ—Å—è—Ü (—Å TTL 60 –¥–Ω–µ–π)
- **–ö–ª—é—á–∏ Redis**:
  - `user:{user_id}:downloads_total` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
  - `user:{user_id}:downloads:day:{YYYYMMDD}` - –∑–∞ –¥–µ–Ω—å (TTL 3 –¥–Ω—è)
  - `user:{user_id}:downloads:month:{YYYYMM}` - –∑–∞ –º–µ—Å—è—Ü (TTL 60 –¥–Ω–µ–π)
  - `video:{hash(video_id)}:downloads_total` - –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ

### ‚úÖ –≠—Ç–∞–ø 3: Event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- **–ú–æ–¥—É–ª—å `events.py`** —Å —Ç–∏–ø–∞–º–∏ —Å–æ–±—ã—Ç–∏–π:
  - `DownloadCompletedEvent` (user_id, video_id, platform, source, timestamp)
  - `VideoViewClickedEvent` (user_id, video_id, event_type, timestamp)
  - `UserReferredEvent` (referrer_id, new_user_id, timestamp)
- **–û—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π –≤ Redis**: `events:analytics_queue`
- **`analytics_worker.py`**:
  - –°–ª—É—à–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π –∏–∑ Redis
  - –û–±–Ω–æ–≤–ª—è–µ—Ç Redis —Å—á—ë—Ç—á–∏–∫–∏ (–±—ã—Å—Ç—Ä–æ)
  - –ü–∏—à–µ—Ç –≤ PostgreSQL (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
  - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ gracefully (–Ω–µ –ø–∞–¥–∞–µ—Ç –Ω–∞ –æ–¥–Ω–æ–º —Å–æ–±—ã—Ç–∏–∏)

### ‚úÖ –≠—Ç–∞–ø 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
- **–í `bot.py`**:
  - –ü—É–±–ª–∏–∫–∞—Ü–∏—è `DownloadCompletedEvent` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç)
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º (Redis get)
- **–í `worker.py`**:
  - –ü—É–±–ª–∏–∫–∞—Ü–∏—è `DownloadCompletedEvent` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
- **–í `inline_handler`**:
  - –ü—É–±–ª–∏–∫–∞—Ü–∏—è `VideoViewClickedEvent` –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
- **–í `cmd_start`**:
  - –ü—É–±–ª–∏–∫–∞—Ü–∏—è `VideoViewClickedEvent` –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ deep link
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ referral –∫–æ–¥–∞ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–∑–∞–≥–ª—É—à–∫–∞)

### ‚úÖ –≠—Ç–∞–ø 5: –õ–∏–º–∏—Ç—ã –∏ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è (10 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–∫–∞—á–∏–≤–∞–Ω–∏–π)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –≤ `download_and_send`**:
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `user:{id}:downloads_total` –∏–∑ Redis
  - –ï—Å–ª–∏ > 10: –ø–æ–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–∫–∞–∑ —Ä–µ–∫–ª–∞–º—ã (–∑–∞–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ –±—É–¥—É—â–µ–µ)
  - –ï—Å–ª–∏ <= 10: –æ–±—ã—á–Ω—ã–π –ø–æ—Ç–æ–∫
- **–¢–∞–±–ª–∏—Ü—ã –¥–ª—è —Ä–µ–∫–ª–∞–º—ã (–∑–∞–≥–æ—Ç–æ–≤–∫–∞)**:
  - `ad_campaigns` (id, name, message, button_text, button_url, is_active, weight)
  - `ad_impressions` (id, user_id, campaign_id, clicked, created_at)
- **–ö–æ–º–∞–Ω–¥–∞ `/stats`**:
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö

### ‚úÖ –≠—Ç–∞–ø 8: –î–∞—à–±–æ—Ä–¥ –∏ –æ—Ç—á—ë—Ç—ã
- **`dashboard.py` (FastAPI)**:
  - `GET /health` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
  - `GET /stats/summary` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –≤–∏–¥–µ–æ, —Å–∫–∞—á–∏–≤–∞–Ω–∏—è)
  - `GET /stats/top-videos?limit=10` - —Ç–æ–ø –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –≤–∏–¥–µ–æ
  - `GET /stats/platforms` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º
  - `GET /stats/active-users?days=7` - –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞ N –¥–Ω–µ–π
- **–ú–µ—Ç–æ–¥—ã –≤ `analytics_db.py`**:
  - `get_summary()` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  - `get_active_users_count(days=7)` - –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    bot.py (main.py)                      ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã                                    ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—ç—à (Redis)                               ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç—ã (Redis)                            ‚îÇ
‚îÇ  ‚Ä¢ –ü—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ –æ—á–µ—Ä–µ–¥—å (Redis)                  ‚îÇ
‚îÇ  ‚Ä¢ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚ñº                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Redis      ‚îÇ  ‚îÇ  Redis Queue     ‚îÇ
‚îÇ  (–∫—ç—à,       ‚îÇ  ‚îÇ  (events:        ‚îÇ
‚îÇ   —Å—á—ë—Ç—á–∏–∫–∏)  ‚îÇ  ‚îÇ   analytics_queue)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                   ‚îÇ
       ‚îÇ                   ‚ñº
       ‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ            ‚îÇ analytics_worker ‚îÇ
       ‚îÇ            ‚îÇ  ‚Ä¢ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç  ‚îÇ
       ‚îÇ            ‚îÇ    —Å–æ–±—ã—Ç–∏—è       ‚îÇ
       ‚îÇ            ‚îÇ  ‚Ä¢ –û–±–Ω–æ–≤–ª—è–µ—Ç     ‚îÇ
       ‚îÇ            ‚îÇ    Redis —Å—á—ë—Ç—á–∏–∫–∏‚îÇ
       ‚îÇ            ‚îÇ  ‚Ä¢ –ü–∏—à–µ—Ç –≤       ‚îÇ
       ‚îÇ            ‚îÇ    PostgreSQL    ‚îÇ
       ‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                     ‚îÇ
       ‚îÇ                     ‚ñº
       ‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ            ‚îÇ   PostgreSQL     ‚îÇ
       ‚îÇ            ‚îÇ  (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞)     ‚îÇ
       ‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                     ‚îÇ
       ‚îÇ                     ‚ñº
       ‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ            ‚îÇ   dashboard.py   ‚îÇ
       ‚îÇ            ‚îÇ  (FastAPI API)   ‚îÇ
       ‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Redis Queue‚îÇ
‚îÇ  (download_tasks)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   worker.py  ‚îÇ
‚îÇ  ‚Ä¢ –°–∫–∞—á–∏–≤–∞–µ—Ç ‚îÇ
‚îÇ    –≤–∏–¥–µ–æ     ‚îÇ
‚îÇ  ‚Ä¢ –ó–∞–≥—Ä—É–∂–∞–µ—Ç ‚îÇ
‚îÇ    –≤ –∫–∞–Ω–∞–ª   ‚îÇ
‚îÇ  ‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç ‚îÇ
‚îÇ    –≤ –∫—ç—à     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å–∫–∞—Ç—å

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

**–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**:
```bash
pip install -r requirements.txt
```

**–ù–∞—Å—Ç—Ä–æ–π—Ç–µ `.env`**:
```env
BOT_TOKEN=your_bot_token_here
TELEGRAM_CHANNEL_ID=your_channel_id_here
REDIS_URL=redis://localhost:6379/0
DATABASE_URL=postgresql://user:password@localhost:5432/analytics
```

**–ó–∞–ø—É—Å—Ç–∏—Ç–µ Redis**:
```bash
# macOS
brew services start redis

# Linux
sudo systemctl start redis

# –ü—Ä–æ–≤–µ—Ä–∫–∞
redis-cli ping  # –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: PONG
```

**–°–æ–∑–¥–∞–π—Ç–µ PostgreSQL –ë–î –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏**:
```bash
# –°–æ–∑–¥–∞—Ç—å –ë–î
createdb analytics

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
python migrations.py
```

### 2. –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ **4 –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤**:

#### –¢–µ—Ä–º–∏–Ω–∞–ª 1: –ë–æ—Ç (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
```bash
python main.py
```
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—ç—à, –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏—è.

#### –¢–µ—Ä–º–∏–Ω–∞–ª 2: Worker –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
```bash
python worker.py
```
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**: –°–∫–∞—á–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ –∏–∑ –æ—á–µ—Ä–µ–¥–∏ Redis, –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤ Telegram –∫–∞–Ω–∞–ª.

#### –¢–µ—Ä–º–∏–Ω–∞–ª 3: Analytics Worker (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
```bash
python analytics_worker.py
```
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –æ–±–Ω–æ–≤–ª—è–µ—Ç Redis —Å—á—ë—Ç—á–∏–∫–∏, –ø–∏—à–µ—Ç –≤ PostgreSQL.

#### –¢–µ—Ä–º–∏–Ω–∞–ª 4: Dashboard API (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
```bash
python dashboard.py
# –∏–ª–∏
uvicorn dashboard:app --reload --port 8000
```
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**: –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç API –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

**–í–∞–∂–Ω–æ**: 
- –ë–æ—Ç –∏ Worker **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ
- Analytics Worker –∏ Dashboard **–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã** - –±–µ–∑ –Ω–∏—Ö –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è

---

## üìä –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞

1. **–û–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å**:
   ```
   –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –±–æ—Ç—É: https://www.instagram.com/reel/ABC123/
   ```

2. **Inline Query**:
   ```
   –í –ª—é–±–æ–º —á–∞—Ç–µ: @botname https://www.tiktok.com/@user/video/123
   ```

3. **–ö–æ–º–∞–Ω–¥–∞ `/stats`**:
   ```
   /stats
   ```
   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
   - –í—Å–µ–≥–æ —Å–∫–∞—á–∞–Ω–æ
   - –°–µ–≥–æ–¥–Ω—è
   - –≠—Ç–æ—Ç –º–µ—Å—è—Ü
   - –û—Å—Ç–∞–≤—à–∏–µ—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–∏–∑ 10)

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)

**Dashboard API** (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω `dashboard.py`):

1. **–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**:
   ```bash
   curl http://localhost:8000/stats/summary
   ```
   –û—Ç–≤–µ—Ç:
   ```json
   {
     "users_count": 150,
     "videos_count": 500,
     "total_downloads": 1200
   }
   ```

2. **–¢–æ–ø –≤–∏–¥–µ–æ**:
   ```bash
   curl http://localhost:8000/stats/top-videos?limit=10
   ```
   –û—Ç–≤–µ—Ç:
   ```json
   [
     {
       "video_id": "instagram:ABC123",
       "platform": "instagram",
       "total_downloads": 45,
       "last_download_at": "2024-01-15T10:30:00"
     },
     ...
   ]
   ```

3. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º**:
   ```bash
   curl http://localhost:8000/stats/platforms
   ```
   –û—Ç–≤–µ—Ç:
   ```json
   {
     "youtube": 400,
     "instagram": 600,
     "tiktok": 200
   }
   ```

4. **–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**:
   ```bash
   curl http://localhost:8000/stats/active-users?days=7
   ```
   –û—Ç–≤–µ—Ç:
   ```json
   {
     "days": 7,
     "active_users_count": 50
   }
   ```

5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏**:
   ```bash
   curl http://localhost:8000/health
   ```
   –û—Ç–≤–µ—Ç:
   ```json
   {
     "status": "ok"
   }
   ```

---

## üéØ –ß—Ç–æ –º—ã –ø–æ–ª—É—á–∏–ª–∏

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫**:
   - –í—Å–µ —Å–æ–±—ã—Ç–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ Redis –æ—á–µ—Ä–µ–¥—å
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º `analytics_worker.py`
   - –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

2. **–ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–æ–≤**:
   - Redis —Å—á—ë—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ PostgreSQL

3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**:
   - –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ `analytics_worker.py` –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - Dashboard —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –±–æ—Ç–∞

4. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å**:
   - –ï—Å–ª–∏ PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
   - –ï—Å–ª–∏ `analytics_worker` —É–ø–∞–ª, —Å–æ–±—ã—Ç–∏—è –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏ Redis
   - –û—à–∏–±–∫–∏ –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ

5. **–ì–∏–±–∫–æ—Å—Ç—å**:
   - –ó–∞–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è —Ä–µ–∫–ª–∞–º—ã (—Ç–∞–±–ª–∏—Ü—ã `ad_campaigns`, `ad_impressions`)
   - –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ A/B —Ç–µ—Å—Ç–∞–º (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–±—ã—Ç–∏–π)
   - –ü—Ä–æ—Å—Ç–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫

### üìà –°–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: –ö—Ç–æ —Å–∫–∞—á–∏–≤–∞–µ—Ç, –∫–æ–≥–¥–∞, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- **–í–∏–¥–µ–æ**: –ö–∞–∫–∏–µ –≤–∏–¥–µ–æ –ø–æ–ø—É–ª—è—Ä–Ω—ã, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å–∫–∞—á–∞–Ω—ã
- **–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã**: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ YouTube/Instagram/TikTok
- **Deep Links**: –°–∫–æ–ª—å–∫–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –ø–æ —Å—Å—ã–ª–∫–∞–º "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ"
- **–ò—Å—Ç–æ—á–Ω–∏–∫–∏**: –û—Ç–∫—É–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –∑–∞–ø—Ä–æ—Å—ã (message/inline/deep_link)

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

1. **–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç?**
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É `/start` - –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å

2. **Worker —Ä–∞–±–æ—Ç–∞–µ—Ç?**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `[worker] Background worker –∑–∞–ø—É—â–µ–Ω`
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ - –¥–æ–ª–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å—Å—è

3. **Analytics Worker —Ä–∞–±–æ—Ç–∞–µ—Ç?**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `[analytics] Analytics worker –∑–∞–ø—É—â–µ–Ω`
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—á–µ—Ä–µ–¥—å Redis: `redis-cli LLEN events:analytics_queue` (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–µ–±–æ–ª—å—à–∞—è)

4. **Dashboard —Ä–∞–±–æ—Ç–∞–µ—Ç?**
   - –û—Ç–∫—Ä–æ–π—Ç–µ: `http://localhost:8000/health`
   - –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `{"status": "ok"}`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö

**Redis —Å—á—ë—Ç—á–∏–∫–∏**:
```bash
redis-cli GET "user:123456789:downloads_total"
redis-cli GET "user:123456789:downloads:day:20240115"
```

**PostgreSQL**:
```sql
-- –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
psql analytics

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT COUNT(*) FROM users;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
SELECT COUNT(*) FROM downloads;

-- –¢–æ–ø –≤–∏–¥–µ–æ
SELECT video_id, total_downloads FROM videos ORDER BY total_downloads DESC LIMIT 10;
```

---

## üêõ Troubleshooting

**–ü—Ä–æ–±–ª–µ–º–∞**: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è
- **–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—É—â–µ–Ω `analytics_worker.py` –∏ PostgreSQL –¥–æ—Å—Ç—É–ø–µ–Ω

**–ü—Ä–æ–±–ª–µ–º–∞**: Dashboard –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `dashboard.py` –∑–∞–ø—É—â–µ–Ω –∏ `DATABASE_URL` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–æ–±—ã—Ç–∏—è –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏
- **–†–µ—à–µ–Ω–∏–µ**: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ–ª—å—à–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ `analytics_worker.py` –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞**: –õ–∏–º–∏—Ç—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Redis –¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Å—á—ë—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è (`redis-cli GET user:...:downloads_total`)

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –≤ Dashboard (Chart.js, Plotly)
2. **A/B —Ç–µ—Å—Ç—ã**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
3. **–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞**: –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è)
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
5. **–ê–ª–µ—Ä—Ç—ã**: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

---

## üéâ –ò—Ç–æ–≥

–°–µ–≥–æ–¥–Ω—è –º—ã —Å–æ–∑–¥–∞–ª–∏ **–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∞–Ω–∞–ª–∏—Ç–∏–∫–∏**, –∫–æ—Ç–æ—Ä–∞—è:
- ‚úÖ –ù–µ –∑–∞–º–µ–¥–ª—è–µ—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ
- ‚úÖ –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –≤–∞–∂–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
- ‚úÖ –ù–∞–¥—ë–∂–Ω–∞ (–Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
- ‚úÖ –ì–æ—Ç–æ–≤–∞ –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é (—Ä–µ–∫–ª–∞–º–∞, A/B —Ç–µ—Å—Ç—ã)

**–í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –±–æ—Ç–∞!** üöÄ
